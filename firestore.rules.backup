rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if user is partner store
    function isPartnerStore() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPartnerStore == true;
    }

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // ğŸ” Users can read/write only their own user profile
    // âœ… Admins can read any user profile
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin()
      );
      allow write: if isAuthenticated() && request.auth.uid == userId;
      // Allow admins to update user roles
      allow update: if isAdmin();
    }

    // ğŸ” Users can access their wallet only
    match /users/{userId}/wallet/{documentId} {
      // Allow users to read and write their own wallet
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Allow admins to read all wallets for management
      allow read: if isAdmin();
    }

    // ğŸ›’ Publicly readable product catalog
    match /products/{productId} {
      allow read: if true;
      // ğŸ” Only admin users can write/update/delete products
      allow write: if isAdmin();
    }

    // ğŸ’³ Partner payments management
    match /payments/{paymentId} {
      // Admins can read and write all payments
      allow read, write: if isAdmin();
      
      // Partner stores can read payments where they are the partner
      allow read: if isAuthenticated() && isPartnerStore() &&
        resource.data.partnerId == request.auth.uid;
    }

    // âœ… Redemption Requests
    match /redemptions/{redemptionId} {
      // Any authenticated user can create a redemption record
      allow create: if isAuthenticated();

      // Users can read their own redemptions
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Partner stores can read redemptions they've confirmed or where they are the partner
      allow read: if isAuthenticated() && isPartnerStore() && (
        resource.data.confirmedByPartner == request.auth.uid ||
        resource.data.partnerId == request.auth.uid ||
        resource.data.storeId == request.auth.uid
      );

      // Partner stores and admins can update/delete redemptions
      allow update, delete: if isAuthenticated() && (
        isPartnerStore() || isAdmin()
      );
    }

    // ğŸª Partner store prices
    match /partner_store_prices/{priceId} {
      // Allow partner stores to read their own price documents
      allow read: if isAuthenticated() && isPartnerStore() &&
        priceId.startsWith(request.auth.uid + '_');
      
      // Allow partner stores to write their own price documents
      allow write: if isAuthenticated() && isPartnerStore() &&
        priceId.startsWith(request.auth.uid + '_');
      
      // Admins can read and write all partner prices
      allow read, write: if isAdmin();
      
      // Allow partner stores to query their prices
      allow list: if isAuthenticated() && isPartnerStore();
    }

    // ğŸ“Š Subscriptions collection
    match /subscriptions/{subscriptionId} {
      // Users can read and write their own subscriptions
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      allow write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }

    // ğŸ”§ Admin data collection
    match /adminData/{docId} {
      allow read, write: if isAdmin();
    }

    // ğŸ“ˆ Analytics and reports (if needed)
    match /analytics/{docId} {
      allow read, write: if isAdmin();
      // Allow partner stores to read their own analytics
      allow read: if isAuthenticated() && isPartnerStore() && 
        resource.data.partnerId == request.auth.uid;
    }

    // ğŸª Partner store specific data
    match /partnerStores/{storeId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == storeId || isAdmin()
      );
      allow write: if isAuthenticated() && (
        request.auth.uid == storeId || isAdmin()
      );
    }
  }
}